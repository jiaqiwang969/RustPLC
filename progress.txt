# Ralph Progress Log
## Codebase Patterns
- TopologyGraph JSON 调试依赖 `petgraph` 的 `serde-1` feature；若缺失会导致 DiGraph 无法序列化。
- In parser-to-AST lowering, unwrap wrapper PEG rules (e.g., `constraint_declaration`, `step_statement`) before matching concrete rule kinds, or valid nodes can be silently skipped.
- Keep public module declarations centralized in `src/lib.rs`; implementation files live at `src/<module>/mod.rs`.
- For early story scaffolding, keep module placeholders compiling so CLI and library can evolve incrementally without breaking builds.
- Model DSL enums with `serde(rename_all = "snake_case")` and tagged enums so serialized AST tokens stay aligned with DSL keywords.
- In pest grammars, define silent `WHITESPACE` and `COMMENT` rules so inline `#` comments and multiline section formatting parse without extra boilerplate.
- For block-style DSL sections, parse optional `reason: "..."` clauses directly in each declaration rule so indented multiline annotations remain valid without separate line handling.
- In nested `parallel`/`race` grammar, require branch bodies to consume concrete statements so step-level directives are not misparsed as branch labels.
Started: Wed Feb 11 01:14:39 CST 2026
---
## [2026-02-11 01:19:50 CST] - US-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented
  - Initialized Cargo project `rust_plc` with required dependencies (`pest`, `pest_derive`, `petgraph`, `serde`, `serde_json`, `thiserror`).
  - Added `src/lib.rs` module exports and placeholder module files for `parser`, `ast`, `ir`, `semantic`, and `error`.
  - Replaced default CLI with argument validation that accepts exactly one `.plc` file path.
- Files changed
  - `Cargo.toml`, `Cargo.lock`, `src/main.rs`, `src/lib.rs`, `src/parser/mod.rs`, `src/ast/mod.rs`, `src/ir/mod.rs`, `src/semantic/mod.rs`, `src/error/mod.rs`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Library-facing modules are declared in `src/lib.rs` even when implementation is still a placeholder.
  - Gotchas encountered (e.g., "do not forget to update Z when changing W")
    - `python` shim is unavailable in this environment; use `python3` for JSON/text automation scripts.
  - Useful context (e.g., "the evaluation panel is in component X")
    - This story established the baseline crate structure; subsequent parser/AST stories can add logic directly in existing module files.
---
## [2026-02-11 01:31:17 CST] - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented
  - Replaced the AST placeholder with typed syntax tree models for topology, constraints, and tasks sections.
  - Added device/constraint/task enums and structs covering all required DSL categories (device types, attributes, safety/timing/causality constraints, actions, wait/timeout/goto/on_complete/parallel/race/allow_indefinite_wait/unreachable).
  - Derived `Debug`, `Clone`, `Serialize`, and `Deserialize` for all AST-facing data structures to support parser output and downstream serialization.
- Files changed
  - `src/ast/mod.rs`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Keeping AST enums `snake_case` via serde attributes avoids ad-hoc keyword conversion once parser lowering starts.
  - Gotchas encountered (e.g., "do not forget to update Z when changing W")
    - `cargo clippy` is unavailable in this toolchain unless the clippy component is installed (`rustup component add clippy`).
  - Useful context (e.g., "the evaluation panel is in component X")
    - `StepStatement` is modeled as a tagged enum, so parser work can map each DSL statement kind directly without extra wrapper types.
---
## [2026-02-11 01:39:19 CST] - US-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented
  - Added `src/parser/plc.pest` with topology-section PEG rules covering `[topology]`, bare port declarations, attribute blocks, all required device types, and all required topology attribute keys.
  - Added parser entrypoint `parse_topology` in `src/parser/mod.rs` using `pest_derive::Parser` against `parser/plc.pest`.
  - Added parser unit tests for the PRD 5.3 topology sample and an additional topology case that exercises every supported device type plus identifier/string/duration/measured/state-reference value forms.
- Files changed
  - `src/parser/plc.pest`, `src/parser/mod.rs`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Defining topology grammar values as a prioritized union (`state_reference` before `identifier`) avoids partial matches when parsing dotted tokens like `cyl_A.extended`.
  - Gotchas encountered (e.g., "do not forget to update Z when changing W")
    - Keep keyword-limited `attribute_name` and `device_type` rules explicit in PEG so unsupported topology keys/types fail fast instead of being accepted as generic identifiers.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `parse_topology` currently validates syntax only; AST lowering for topology/constraints/tasks is expected in a later parser story.
---
## [2026-02-11 01:44:22 CST] - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented
  - Extended `src/parser/plc.pest` with `[constraints]` grammar coverage for `safety` (`conflicts_with` + `requires`), `timing` (`must_complete_within` + `must_start_after`), and `causality` chain declarations.
  - Added shared grammar primitives for `timing_scope`, causality arrows, and optional `reason: "..."` clauses so both inline and indented reason annotations parse correctly.
  - Added parser API `parse_constraints` and unit tests for the PRD 5.4 constraints sample plus a focused case covering `requires` and `must_start_after`.
- Files changed
  - `src/parser/plc.pest`, `src/parser/mod.rs`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Keeping section-specific parse entrypoints (`parse_topology`, `parse_constraints`) makes it easy to ship grammar stories incrementally while preserving isolated test coverage.
  - Gotchas encountered (e.g., "do not forget to update Z when changing W")
    - `timing` scopes are intentionally constrained to `task.<name>` or `task.<name>.<step>`; broad identifier chains would over-accept invalid DSL forms.
  - Useful context (e.g., "the evaluation panel is in component X")
    - Constraint parsing is still syntax-only; semantic validation for device/task existence and chain connectivity is deferred to later semantic/verification stories.
---
## [2026-02-11 07:26:44 CST] - US-005
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented
  - Extended `src/parser/plc.pest` with `[tasks]` grammar for task/step declarations, action/wait/timeout/goto statements, `on_complete`, and `allow_indefinite_wait`.
  - Added nested control-flow grammar support for `parallel` and `race` blocks, including branch parsing and `then: goto` handling in race branches.
  - Added `parse_tasks` in `src/parser/mod.rs` plus parser unit tests covering PRD sections 5.5.1 through 5.5.5.
- Files changed
  - `src/parser/plc.pest`, `src/parser/mod.rs`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Task grammar entrypoints follow the same section-scoped API pattern as existing parser functions (`parse_topology`/`parse_constraints`), which keeps parser stories independently testable.
  - Gotchas encountered (e.g., "do not forget to update Z when changing W")
    - In PEG branch grammars, letting branch bodies be empty can cause tokens like `timeout:` to be accidentally treated as new branch labels; require concrete branch content to avoid this.
  - Useful context (e.g., "the evaluation panel is in component X")
    - Current task parsing remains syntax-only; AST lowering for task statements is still pending the dedicated parser-to-AST story.
---
## [2026-02-11 08:53:35 CST] - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented
  - Added full parser-to-AST builder entrypoint `parse_plc` that parses `[topology]`, `[constraints]`, and `[tasks]` into `PlcProgram` with typed AST nodes.
  - Implemented detailed lowering helpers for devices/attributes, safety-timing-causality constraints, task-step statements, nested `parallel`/`race` branches, and directives (`timeout`, `goto`, `on_complete`, `allow_indefinite_wait`).
  - Added parser error mapping to `PlcError` with line-numbered Chinese diagnostics and added a regression test to assert line reporting on syntax failures.
  - Added end-to-end AST construction tests for PRD 6.3 and PRD 9 complete PLC examples with key field assertions.
- Files changed
  - `.ralph_logs/iter_4.log`, `.ralph_logs/iter_5.log`, `.ralph_logs/iter_6.log`, `src/parser/mod.rs`, `src/parser/plc.pest`, `src/error/mod.rs`, `prd.json`, `progress.txt`
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Parser lowering is most robust when each grammar wrapper rule is unwrapped immediately, then dispatched by concrete sub-rule for AST conversion.
  - Gotchas encountered (e.g., "do not forget to update Z when changing W")
    - `Pair::into_inner()` consumes the pair; preserve `pair.as_str()` beforehand when fallback logic needs original token text (e.g., `on_complete: unreachable`).
  - Useful context (e.g., "the evaluation panel is in component X")
    - Causality chains in current AST are stored as `Vec<StateReference>` using device names with empty `state`; downstream IR/semantic stories should normalize this to explicit device-chain representation.
---
## [2026-02-11 09:02:01 CST] - US-007
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented
  - Replaced `src/ir/mod.rs` placeholder with concrete IR definitions for `TopologyGraph`, `StateMachine`, `ConstraintSet`, and `TimingModel`.
  - Implemented `TopologyGraph` on top of `petgraph::DiGraph<Device, ConnectionType>` with helper APIs for adding devices and connections.
  - Added typed state machine/constraint/timing structures plus `to_pretty_json` helper so IR objects can be serialized with `serde_json::to_string_pretty` for debugging.
  - Added IR unit tests that verify graph node/edge behavior and pretty-JSON serialization/deserialization for all core IR models.
  - Enabled `petgraph`'s `serde-1` feature in Cargo dependencies so graph serialization works.
- Files changed
  - `Cargo.toml`, `Cargo.lock`, `src/ir/mod.rs`, `prd.json`, `progress.txt`, `.ralph_logs/iter_6.log`, `.ralph_logs/iter_7.log`
- **Learnings for future iterations:**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Keep IR enums `snake_case` with serde tags to make debug JSON stable and easy to diff against DSL keywords.
  - Gotchas encountered (e.g., "do not forget to update Z when changing W")
    - `petgraph::DiGraph` serialization requires the crate feature `serde-1`; adding derives alone is not enough.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `TimingModel` currently stores action timing intervals keyed by deterministic strings (`task.step.action.target`) for straightforward lookup in upcoming semantic stories.
---
